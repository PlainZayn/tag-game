<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Multiplayer Tag Game</title>
<script src="https://cdn.jsdelivr.net/npm/colyseus.js"></script>
<style>
  html,body{height:100%;margin:0;background:red;color:#e6eef8;font-family:system-ui,sans-serif;}
  .overlay{
    position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);
    display:flex;justify-content:center;align-items:center;flex-direction:column;gap:16px;
  }
  .overlay h2{color:#ffd166;margin:0;}
  .overlay label{display:flex;justify-content:space-between;width:260px;margin:4px 0;}
  .overlay input[type=color]{width:60px;}
  .overlay input[type=number]{width:60px;}
  .overlay button{background:#ffd166;border:0;padding:8px 12px;border-radius:8px;font-weight:600;cursor:pointer;}
  .container{display:flex;gap:12px;padding:12px;display:none;}
  canvas{background:linear-gradient(#08101a,#071623);border-radius:10px;width:960px;height:540px;
         box-shadow:0 6px 30px rgba(0,0,0,.7);}
  .controls{background:#0b1220cc;border-radius:10px;padding:12px;width:220px;}
  .controls h3{margin-top:0;color:#ffd166;}
  .controls ul{padding-left:16px;}
  .controls li{margin-bottom:6px;}
  .controls button{margin-top:6px;}
</style>
</head>
<body>

<div class="overlay" id="menu">
  <h2>Custom Match Settings</h2>
  <label>Player 1 Color: <input type="color" id="p1Color" value="#9b59b6"></label>
  <label>Player 2 Color: <input type="color" id="p2Color" value="#f1c40f"></label>
  <label>Match Time (seconds): <input type="number" id="timeLimit" min="30" max="300" value="90"></label>
  <button id="startBtn">Start Match</button>
</div>

<div class="container" id="gameContainer">
  <canvas id="game" width="960" height="540"></canvas>
  <div class="controls">
    <h3>Controls</h3>
    <strong>Player 1</strong>
    <ul>
      <li>Move: A / D</li>
      <li>Jump: W</li>
      <li>Fast Fall: S</li>
    </ul>
    <strong>Player 2</strong>
    <ul>
      <li>Move: ← / →</li>
      <li>Jump: ↑</li>
      <li>Fast Fall: ↓</li>
    </ul>
    <strong>General</strong>
    <ul>
      <li>Restart / Back to Menu: R</li>
    </ul>
    <button id="restartBtn">Restart</button>
  </div>
</div>

<script>
(async () => {
  const canvas=document.getElementById("game");
  const ctx=canvas.getContext("2d");
  const container=document.getElementById("gameContainer");
  const menu=document.getElementById("menu");
  const startBtn=document.getElementById("startBtn");
  const restartBtn=document.getElementById("restartBtn");
  const p1ColorInput=document.getElementById("p1Color");
  const p2ColorInput=document.getElementById("p2Color");
  const timeInput=document.getElementById("timeLimit");

  let GAME_SECONDS=90;
  const GRAVITY=1800,MOVE_SPEED=360,ACCEL=2800,FRICTION=2400,JUMP_SPEED=650,TAG_COOLDOWN=0.4,FAST_FALL_MULT=2.5;
  const platforms=[
    {x:0,y:500,w:960,h:40},{x:60,y:420,w:200,h:20},{x:320,y:360,w:160,h:20},
    {x:600,y:400,w:200,h:20},{x:760,y:320,w:180,h:20},{x:200,y:280,w:160,h:20},
    {x:440,y:230,w:120,h:20},{x:650,y:260,w:160,h:20},{x:300,y:160,w:180,h:20},
    {x:520,y:120,w:160,h:20},
  ];

  let room=null;
  let playerId=null;
  let p1=null,p2=null;
  let elapsed=0,finished=false,lastTime=performance.now();
  let myPlayerNumber=null;

  // Connect to Colyseus server
  const client=new Colyseus.Client("ws://localhost:2567");

  const keys={};
  window.addEventListener("keydown",e=>{
    if(e.repeat)return;
    keys[e.key.toLowerCase()]=true;
    handleKey(e.key.toLowerCase(),true);
    if(e.key.toLowerCase()==="r")goToMenu();
  });
  window.addEventListener("keyup",e=>{
    keys[e.key.toLowerCase()]=false;
    handleKey(e.key.toLowerCase(),false);
  });

  function handleKey(k,v){
    if(room && myPlayerNumber){
      if(myPlayerNumber===1){
        if(k==="a")room.send("input",{left:v,right:false,jump:false,down:false});
        if(k==="d")room.send("input",{left:false,right:v,jump:false,down:false});
        if(k==="w")room.send("input",{left:false,right:false,jump:v,down:false});
        if(k==="s")room.send("input",{left:false,right:false,jump:false,down:v});
      }else{
        if(k==="arrowleft")room.send("input",{left:v,right:false,jump:false,down:false});
        if(k==="arrowright")room.send("input",{left:false,right:v,jump:false,down:false});
        if(k==="arrowup")room.send("input",{left:false,right:false,jump:v,down:false});
        if(k==="arrowdown")room.send("input",{left:false,right:false,jump:false,down:v});
      }
    }
  }

  startBtn.onclick=startMatch;
  restartBtn.onclick=goToMenu;

  async function startMatch(){
    try{
      GAME_SECONDS=parseInt(timeInput.value);
      room=await client.joinOrCreate("tag_game",{timeLimit:GAME_SECONDS,p1Color:p1ColorInput.value,p2Color:p2ColorInput.value});
      playerId=room.sessionId;

      room.state.players.onAdd=(player,key)=>{
        console.log("Player joined:",key,player);
      };

      room.state.players.onChange=(player,key)=>{
        if(key==="player1"){
          p1={
            x:player.x,y:player.y,w:28,h:40,vx:player.vx,vy:player.vy,
            color:player.color,label:"P1",isIt:player.isIt,itTime:player.itTime
          };
          if(playerId===player.id)myPlayerNumber=1;
        }else if(key==="player2"){
          p2={
            x:player.x,y:player.y,w:28,h:40,vx:player.vx,vy:player.vy,
            color:player.color,label:"P2",isIt:player.isIt,itTime:player.itTime
          };
          if(playerId===player.id)myPlayerNumber=2;
        }
      };

      room.state.onChange=()=>{
        elapsed=room.state.elapsed;
        finished=room.state.finished;
        if(finished && !document.hidden){
          setTimeout(()=>{
            let msg=`Time's up!\n\nP1 It: ${room.state.p1Time.toFixed(2)}s\nP2 It: ${room.state.p2Time.toFixed(2)}s\n\n`;
            if(Math.abs(room.state.p1Time-room.state.p2Time)<0.05)msg+="Draw!";
            else if(room.state.p1Time<room.state.p2Time)msg+="Player 1 wins!";
            else msg+="Player 2 wins!";
            alert(msg);
          },100);
        }
      };

      elapsed=0;finished=false;lastTime=performance.now();
      menu.style.display="none"; container.style.display="flex";
      requestAnimationFrame(loop);
    }catch(e){
      console.error("Failed to join game:",e);
      alert("Failed to connect to server. Make sure the server is running on ws://localhost:2567");
    }
  }

  function goToMenu(){
    menu.style.display="flex";
    container.style.display="none";
    if(room){room.leave();}
    p1=null; p2=null;
  }

  function draw(){
    if(!p1 || !p2)return;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.save();ctx.globalAlpha=0.05;ctx.fillStyle="#fff";
    for(let gx=0;gx<canvas.width;gx+=40)ctx.fillRect(gx,0,1,canvas.height);
    for(let gy=0;gy<canvas.height;gy+=40)ctx.fillRect(0,gy,canvas.width,1);
    ctx.restore();

    ctx.fillStyle="#0f2533";for(const pl of platforms)ctx.fillRect(pl.x,pl.y,pl.w,pl.h);
    drawPlayer(p1);drawPlayer(p2);

    ctx.fillStyle="#fff";ctx.font="14px monospace";
    ctx.fillText(`Time left: ${(GAME_SECONDS-elapsed).toFixed(1)}s`,10,22);
    ctx.fillText(`P1 It: ${(room?.state?.p1Time||0).toFixed(1)}s`,10,42);
    ctx.fillText(`P2 It: ${(room?.state?.p2Time||0).toFixed(1)}s`,10,62);
    ctx.fillText(`You are: P${myPlayerNumber}`,10,82);
  }

  function drawPlayer(p){
    ctx.save();
    if(p.isIt){ctx.strokeStyle="#ff6b6b";ctx.lineWidth=3;ctx.strokeRect(p.x-2,p.y-2,p.w+4,p.h+4);}
    ctx.fillStyle=p.color;ctx.fillRect(p.x,p.y,p.w,p.h);
    ctx.fillStyle="#fff";ctx.font="12px sans-serif";ctx.fillText(p.label,p.x,p.y-6);
    ctx.restore();
  }

  function loop(ts){
    if(!p1 || !p2)return;
    draw();requestAnimationFrame(loop);
  }
})();
</script>
</body>
</html>
